#  iOS 2021 é¢è¯•å‰çš„å‡†å¤‡ï¼ˆæ€»ç»“å„çŸ¥è¯†ç‚¹æ–¹ä¾¿é¢è¯•å‰å¿«é€Ÿå¤ä¹ ä½¿ç”¨ï¼‰ï¼ˆå…«ï¼‰

## 64. extension å’Œ cateogry åŒºåˆ«ã€‚
1. extension å¯ä»¥æ·»åŠ æˆå‘˜å˜é‡ï¼Œcategory ä¸èƒ½æ·»åŠ æˆå‘˜å˜é‡ã€‚è¿è¡Œæ—¶åŠ è½½ç±»åˆ°å†…å­˜ä»¥åï¼Œæ‰ä¼šåŠ è½½åˆ†ç±»ï¼Œè¿™æ—¶ç±»çš„å†…å­˜å¸ƒå±€å·²ç»ç¡®å®šï¼ˆç¼–è¯‘å™¨è¿˜ä¼šå¯¹æˆå‘˜å˜é‡é¡ºåºåšå‡ºä¼˜åŒ–ï¼Œä¿è¯éµå¾ªå†…å­˜å¯¹é½åŸåˆ™ä¸‹ç±»å ç”¨å†…å­˜å®¹é‡æœ€å°‘ï¼‰ï¼Œå¦‚æœå†å»æ·»åŠ æˆå‘˜å˜é‡å°±ä¼šç ´åç±»çš„å†…å­˜å¸ƒå±€ã€‚å„ä¸ªæˆå‘˜å˜é‡çš„è®¿é—®åœ°å€æ˜¯åœ¨ç¼–è¯‘æ—¶ç¡®å®šçš„ï¼Œæ¯ä¸ªæˆå‘˜å˜é‡çš„åœ°å€åç§»éƒ½æ˜¯å›ºå®šçš„ï¼ˆç›¸å¯¹äºç±»çš„èµ·å§‹åœ°å€çš„å†…å­˜åç§»ï¼ˆç¡¬ç¼–ç ï¼‰ï¼‰ã€‚
2. extension åœ¨ç¼–è¯‘æœŸå†³è®®ï¼ˆå°±ç¡®å®šäº†æ˜¯ç±»çš„ä¸€éƒ¨åˆ†ï¼‰ï¼Œcategory åœ¨è¿è¡ŒæœŸå†³è®®ã€‚extension åœ¨ç¼–è¯‘æœŸå’Œå¤´æ–‡ä»¶é‡Œçš„ @interface ä»¥åŠå®ç°æ–‡ä»¶é‡Œçš„ @implementation ä¸€èµ·å½¢æˆä¸€ä¸ªå®Œæ•´çš„ç±»ï¼Œextension ä¼´éšç±»çš„äº§ç”Ÿè€Œäº§ç”Ÿï¼Œäº¦éšä¹‹ä¸€èµ·æ¶ˆäº¡ã€‚  category ä¸­çš„æ–¹æ³•æ˜¯åœ¨è¿è¡Œæ—¶å†³è®®çš„ï¼Œæ²¡æœ‰å®ç°ä¹Ÿå¯ä»¥è¿è¡Œï¼Œè€Œ extension ä¸­çš„æ–¹æ³•æ˜¯åœ¨ç¼–è¯‘æœŸæ£€æŸ¥çš„ï¼Œæ²¡æœ‰å®ç°ä¼šæŠ¥é”™ã€‚
3. extension ä¸€èˆ¬ç”¨æ¥éšè—ç±»çš„ç§æœ‰ä¿¡æ¯ï¼Œæ— æ³•ç›´æ¥ä¸ºç³»ç»Ÿçš„ç±»æ‰©å±•ï¼Œä½†å¯ä»¥å…ˆåˆ›å»ºç³»ç»Ÿç±»çš„å­ç±»å†æ·»åŠ  extensionã€‚ 
4. category å¯ä»¥ç»™ç³»ç»Ÿæä¾›çš„ç±»æ·»åŠ åˆ†ç±»ã€‚
5. extension å’Œ category éƒ½å¯ä»¥æ·»åŠ å±æ€§ï¼Œä½†æ˜¯ category ä¸­çš„å±æ€§ä¸èƒ½ç”Ÿæˆå¯¹åº”çš„æˆå‘˜å˜é‡ä»¥åŠ getter å’Œ setter æ–¹æ³•çš„å®ç°ã€‚
6. extension ä¸èƒ½åƒ category é‚£æ ·æ‹¥æœ‰ç‹¬ç«‹çš„å®ç°éƒ¨åˆ†ï¼ˆ@implementation éƒ¨åˆ†ï¼‰ï¼Œextension æ‰€å£°æ˜çš„æ–¹æ³•å¿…é¡»ä¾æ‰˜å¯¹åº”ç±»çš„å®ç°éƒ¨åˆ†æ¥å®ç°ã€‚

***

## 65. Category çš„ä¸€äº›ä½œç”¨ä¸ç‰¹ç‚¹ã€‚
&emsp;category æ˜¯ Objective-C 2.0 ä¹‹åæ·»åŠ çš„è¯­è¨€ç‰¹æ€§ï¼Œ**å®ƒå¯ä»¥åœ¨ä¸æ”¹å˜æˆ–ä¸ç»§æ‰¿åŸç±»çš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€åœ°ç»™ç±»æ·»åŠ æ–¹æ³•**ã€‚é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€äº›å…¶ä»–çš„åº”ç”¨åœºæ™¯:
1. å¯ä»¥æŠŠç±»çš„çš„å®ç°åˆ†å¼€åœ¨å‡ ä¸ªä¸åŒçš„æ–‡ä»¶é‡Œé¢ã€‚è¿™æ ·åšæœ‰å‡ ä¸ªæ˜¾è€Œæ˜“è§çš„å¥½å¤„ï¼š
  + å¯ä»¥å‡å°‘å•ä¸ªæ–‡ä»¶çš„ä½“ç§¯ã€‚
  + å¯ä»¥æŠŠä¸åŒçš„åŠŸèƒ½ç»„ç»‡åˆ°ä¸åŒçš„ category é‡Œé¢ã€‚
  + å¯ä»¥ç”±å¤šä¸ªå¼€å‘è€…å…±åŒå®Œæˆä¸€ä¸ªç±»ã€‚
  + å¯ä»¥æŒ‰éœ€åŠ è½½æƒ³è¦çš„ categoryã€‚
  + å£°æ˜ç§æœ‰æ–¹æ³•ã€‚
2. å¦å¤–è¿˜è¡ç”Ÿå‡º category å…¶ä»–å‡ ä¸ªåœºæ™¯:
  + æ¨¡æ‹Ÿå¤šç»§æ‰¿ï¼ˆå¦å¤–å¯ä»¥æ¨¡æ‹Ÿå¤šç»§æ‰¿çš„è¿˜æœ‰ protocolï¼‰ã€‚
  + æŠŠ framework çš„ç§æœ‰æ–¹æ³•å…¬å¼€ã€‚
  
&emsp;category çš„ä¸€äº›ç‰¹ç‚¹ï¼š
1. category åªèƒ½ç»™æŸä¸ªå·²æœ‰çš„ç±»æ‰©å……æ–¹æ³•ï¼Œä¸èƒ½æ‰©å……æˆå‘˜å˜é‡ã€‚
2. category ä¸­ä¹Ÿå¯ä»¥æ·»åŠ å±æ€§ï¼Œåªä¸è¿‡ @property åªä¼šç”Ÿæˆ setter å’Œ getter çš„å£°æ˜ï¼Œä¸ä¼šç”Ÿæˆ setter å’Œ getter çš„å®ç°ä»¥åŠæˆå‘˜å˜é‡ã€‚
3. å¦‚æœ category ä¸­çš„æ–¹æ³•å’Œç±»ä¸­çš„åŸç”¨æ–¹æ³•åŒåï¼Œè¿è¡Œæ—¶ä¼šä¼˜å…ˆè°ƒç”¨ category ä¸­çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ï¼Œcategory ä¸­çš„æ–¹æ³•ä¼šè¦†ç›–æ‰ç±»ä¸­åŸæœ‰çš„æ–¹æ³•ï¼Œæ‰€ä»¥å¼€å‘ä¸­å°½é‡ä¿è¯ä¸è¦è®©åˆ†ç±»ä¸­çš„æ–¹æ³•å’ŒåŸæœ‰ç±»ä¸­çš„æ–¹æ³•åç›¸åŒï¼Œé¿å…å‡ºç°è¿™ç§æƒ…å†µçš„è§£å†³æ–¹æ¡ˆæ˜¯ç»™ç±»çš„æ–¹æ³•åç»Ÿä¸€æ·»åŠ å‰ç¼€ï¼Œæ¯”å¦‚ category_ã€‚
4. å¦‚æœå¤šä¸ª category ä¸­å­˜åœ¨åŒåçš„æ–¹æ³•ï¼Œè¿è¡Œæ—¶åˆ°åº•è°ƒç”¨å“ªä¸ªæ–¹æ³•ç”±ç¼–è¯‘é¡ºåºå†³å®šï¼Œæœ€åä¸€ä¸ªå‚ä¸ç¼–è¯‘çš„æ–¹æ³•ä¼šè¢«è°ƒç”¨ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ Compile Sources ä¸­æ‹–åŠ¨ä¸åŒåˆ†ç±»çš„é¡ºåºæ¥æµ‹è¯•ã€‚
5. è°ƒç”¨ä¼˜å…ˆçº§ï¼Œcategory > æœ¬ç±» > çˆ¶ç±»ã€‚å³ä¼˜å…ˆè°ƒç”¨ category ä¸­çš„æ–¹æ³•ï¼Œç„¶åè°ƒç”¨æœ¬ç±»æ–¹æ³•ï¼Œæœ€åè°ƒç”¨çˆ¶ç±»æ–¹æ³•ã€‚æ³¨æ„ï¼šcategory æ˜¯åœ¨è¿è¡Œæ—¶æ·»åŠ çš„ï¼Œä¸æ˜¯åœ¨ç¼–è¯‘æ—¶ã€‚

æ³¨æ„ï¼š
+ category çš„æ–¹æ³•æ²¡æœ‰ â€œå®Œå…¨æ›¿æ¢æ‰â€ åŸæ¥ç±»å·²ç»æœ‰çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœ category å’ŒåŸæ¥ç±»éƒ½æœ‰ methodAï¼Œé‚£ä¹ˆ category é™„åŠ å®Œæˆä¹‹åï¼Œç±»çš„æ–¹æ³•åˆ—è¡¨é‡Œä¼šæœ‰ä¸¤ä¸ª methodAã€‚
+ category çš„æ–¹æ³•è¢«æ”¾åˆ°äº†æ–°æ–¹æ³•åˆ—è¡¨çš„å‰é¢ï¼Œè€ŒåŸæ¥ç±»çš„æ–¹æ³•è¢«æ”¾åˆ°äº†æ–°æ–¹æ³•åˆ—è¡¨çš„åé¢ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³å¸¸æ‰€è¯´çš„ category çš„æ–¹æ³•ä¼š â€œè¦†ç›–â€ æ‰åŸæ¥ç±»çš„åŒåæ–¹æ³•ï¼Œè¿™æ˜¯å› ä¸ºè¿è¡Œæ—¶åœ¨æŸ¥æ‰¾æ–¹æ³•çš„æ—¶å€™æ˜¯é¡ºç€æ–¹æ³•åˆ—è¡¨çš„é¡ºåºæŸ¥æ‰¾çš„ï¼Œå®ƒåªè¦ä¸€æ‰¾åˆ°å¯¹åº”åå­—çš„æ–¹æ³•ï¼Œå°±ä¼šç½¢ä¼‘ï¼Œæ®Šä¸çŸ¥åé¢å¯èƒ½è¿˜æœ‰ä¸€æ ·åå­—çš„æ–¹æ³•ã€‚

***

## 66. Category ä¸­èƒ½æ·»åŠ å±æ€§å—ï¼Ÿ
&emsp;category ä¸èƒ½æ·»åŠ æˆå‘˜å˜é‡ï¼ˆinstance variablesï¼‰ï¼Œé‚£åˆ°åº•èƒ½ä¸èƒ½æ·»åŠ å±æ€§ï¼ˆ@propertyï¼‰å‘¢ï¼Ÿä¸‹é¢ä» category çš„ç»“æ„ä½“å¼€å§‹åˆ†æï¼Œcategory_t å®šä¹‰:
```c++
// classref_t is unremapped class_t*
typedef struct classref * classref_t;

struct category_t {
    const char *name; // åˆ†ç±»çš„åå­—
    classref_t cls; // æ‰€å±çš„ç±» 
    struct method_list_t *instanceMethods; // å®ä¾‹æ–¹æ³•åˆ—è¡¨
    struct method_list_t *classMethods; // ç±»æ–¹æ³•åˆ—è¡¨
    struct protocol_list_t *protocols; // åè®®åˆ—è¡¨
    struct property_list_t *instanceProperties; // å®ä¾‹å±æ€§åˆ—è¡¨
    
    // Fields below this point are not always present on disk.
    struct property_list_t *_classProperties; // ç±»å±æ€§åˆ—è¡¨
    
    // è¿”å› ç±»/å…ƒç±» æ–¹æ³•åˆ—è¡¨
    method_list_t *methodsForMeta(bool isMeta) {
        if (isMeta) return classMethods;
        else return instanceMethods;
    }

    property_list_t *propertiesForMeta(bool isMeta, struct header_info *hi);
    
    // åè®®åˆ—è¡¨ï¼Œå…ƒç±»æ²¡æœ‰åè®®åˆ—è¡¨
    protocol_list_t *protocolsForMeta(bool isMeta) {
        // è¿™é‡Œå¦‚æœæ˜¯å…ƒç±»çš„è¯ä¼šè¿”å› nullptrï¼Œä½†æ˜¯åœ¨ load_categories_nolock å‡½æ•°ä¸­æœ‰è²Œä¼¼æŠŠ protocols æ·»åŠ åˆ°å…ƒç±»çš„è¿¹è±¡ï¼Œ
        // ä½†æ˜¯åœ¨ attachCategories å‡½æ•°ä¸­ protocolsForMeta å‡½æ•°è¿”å› nullptrï¼Œåº”è¯¥æ˜¯æ²¡æœ‰å®é™…æ·»åŠ ã€‚
        if (isMeta) return nullptr;
        else return protocols;
    }
};

/*
* category_t::propertiesForMeta
* è¿”å› category çš„ å®ä¾‹ æˆ– ç±» çš„å±æ€§ã€‚
* hi æ˜¯åŒ…å« category çš„é•œåƒï¼ˆimagesï¼‰ã€‚
*/
property_list_t *
category_t::propertiesForMeta(bool isMeta, struct header_info *hi)
{
    if (!isMeta) return instanceProperties; // è¿”å›å®ä¾‹å±æ€§
    else if (hi->info()->hasCategoryClassProperties()) return _classProperties; // è¿”å›ç±»å±æ€§
    else return nil; // å…¶ä»–æƒ…å†µè¿”å› nil
}
```
&emsp;ä» category å®šä¹‰ä¸­å¯ä»¥çœ‹å‡º category å¯ä»¥æ·»åŠ å®ä¾‹æ–¹æ³•ã€ç±»æ–¹æ³•ä¹Ÿå¯ä»¥å®ç°åè®®ã€æ·»åŠ å±æ€§ï¼ŒåŒæ—¶ä¹Ÿçœ‹åˆ°ä¸èƒ½æ·»åŠ æˆå‘˜å˜é‡ã€‚é‚£ä¸ºä»€ä¹ˆè¯´ä¸èƒ½æ·»åŠ å±æ€§å‘¢ï¼Ÿå®é™…ä¸Šï¼Œcategory å…è®¸æ·»åŠ å±æ€§ï¼Œå¯ä»¥ä½¿ç”¨ @property æ·»åŠ ï¼Œä½†æ˜¯èƒ½æ·»åŠ  @property ä¸ä»£è¡¨å¯ä»¥æ·»åŠ  â€œå®Œæ•´ç‰ˆçš„â€ å±æ€§ï¼Œé€šå¸¸æˆ‘ä»¬è¯´çš„æ·»åŠ å±æ€§æ˜¯æŒ‡ç¼–è¯‘å™¨ä¸ºæˆ‘ä»¬ç”Ÿæˆäº†å¯¹åº”çš„æˆå‘˜å˜é‡å’Œå¯¹åº”çš„ setter å’Œ getter æ–¹æ³•æ¥å­˜å–å±æ€§ã€‚åœ¨ category ä¸­è™½è¯´å¯ä»¥ä¹¦å†™ @propertyï¼Œä½†æ˜¯ä¸ä¼šç”Ÿæˆ \_æˆå‘˜å˜é‡ï¼Œä¹Ÿä¸ä¼šç”Ÿæˆæ‰€æ·»åŠ å±æ€§çš„ getter å’Œ setter æ–¹æ³•çš„å®ç°ï¼Œæ‰€ä»¥å°½ç®¡æ·»åŠ äº†å±æ€§ï¼Œä¹Ÿæ— æ³•ä½¿ç”¨ç‚¹è¯­æ³•è°ƒç”¨ setter å’Œ getter æ–¹æ³•ã€‚ï¼ˆå®é™…ä¸Šï¼Œç‚¹è¯­æ³•å¯ä»¥å†™ï¼Œåªä¸è¿‡åœ¨è¿è¡Œæ—¶è°ƒç”¨åˆ°è¿™ä¸ªæ–¹æ³•æ—¶ä¼šæŠ¥æ‰¾ä¸åˆ°æ–¹æ³•çš„é”™è¯¯ç›´æ¥ crash: unrecognized selector sent to instance ....ï¼‰ã€‚æˆ‘ä»¬æ­¤æ—¶å¯ä»¥é€šè¿‡ Associated object æ¥ä¸ºå±æ€§æ‰‹åŠ¨å®ç° setter å’Œ getter å­˜å–æ–¹æ³•ã€‚

***

## 67. attachLists Category æ•°æ®è¿½åŠ åˆ°åŸç±»ä¸­å»ã€‚
&emsp;è¿™æ—¶æˆ‘ä»¬å¤§æ¦‚ä¼šæœ‰ä¸€ä¸ªç–‘é—®ï¼Œè¿™äº›å®šä¹‰å¥½çš„ \_category_t æ•°æ®ä»€ä¹ˆæ—¶å€™é™„åŠ åˆ°ç±»ä¸Šå»å‘¢ï¼Ÿæˆ–è€…æ˜¯å­˜æ”¾åœ¨å†…å­˜å“ªé‡Œç­‰ç€æˆ‘ä»¬å»è°ƒç”¨å®ƒé‡Œé¢çš„å®ä¾‹å‡½æ•°æˆ–ç±»å‡½æ•°å‘¢ï¼Ÿ**å·²çŸ¥åˆ†ç±»æ•°æ®æ˜¯ä¼šå…¨éƒ¨è¿½åŠ åˆ°ç±»æœ¬èº«ä¸Šå»çš„ã€‚** ä¸æ˜¯ç±»ä¼¼ weak æœºåˆ¶æˆ–è€… Associated object æœºåˆ¶ç­‰ï¼Œå†å¦å¤–å‡†å¤‡å“ˆå¸Œè¡¨å­˜æ”¾æ•°æ®ï¼Œç„¶åæ ¹æ®å¯¹è±¡åœ°å€å»è¯»å–å¤„ç†æ•°æ®ç­‰è¿™æ ·çš„æ¨¡å¼ã€‚

&emsp;ä¸‹é¢æˆ‘ä»¬å°±å¼€å§‹ç ”ç©¶åˆ†ç±»çš„æ•°æ®æ˜¯å¦‚ä½•è¿½åŠ åˆ°æœ¬ç±»ä¸Šå»çš„ã€‚

&emsp;category çš„åŠ è½½æ¶‰åŠåˆ° runtime çš„åˆå§‹åŒ–åŠåŠ è½½æµç¨‹ä¸”å†…å®¹å®åœ¨è¿‡äºå¤šï¼Œè¿™é‡Œåªæ˜¯ç²—ç•¥çš„äº†è§£ä¸‹ã€‚æ­¤å¤„åªç ”ç©¶ runtime åˆå§‹åŒ–åŠ è½½è¿‡ç¨‹ä¸­æ¶‰åŠçš„ category çš„åŠ è½½ã€‚Objective-C çš„è¿è¡Œæ˜¯ä¾èµ– runtime æ¥åšçš„ï¼Œè€Œ runtime å’Œå…¶ä»–ç³»ç»Ÿåº“ä¸€æ ·ï¼Œæ˜¯ç”± macOS å’Œ iOS é€šè¿‡ dyldï¼ˆthe dynamic link editorï¼‰æ¥åŠ¨æ€åŠ è½½çš„ã€‚

&emsp;map_images_nolock ä¸»è¦åšäº† 4 ä»¶äº‹:
1. æ‹¿åˆ° dlyd ä¼ è¿‡æ¥çš„ mach_headerï¼Œå°è£…ä¸º header_infoã€‚ 
2. åˆå§‹åŒ– selectorã€‚ 
3. arr_init() å†…éƒ¨: åˆå§‹åŒ– AutoreleasePoolPageã€åˆå§‹åŒ– SideTablesMapã€åˆå§‹åŒ– AssociationsManager æ‰€ä½¿ç”¨çš„æ•°æ®ç»“æ„ã€‚
  ```c++
  void arr_init(void) {
      AutoreleasePoolPage::init(); // è‡ªåŠ¨é‡Šæ”¾æ± åˆå§‹åŒ–
      SideTablesMap.init(); // SideTablesMap åˆå§‹åŒ–
      _objc_associations_init(); // AssociationsManager::init(); åˆå§‹åŒ–
  }
  ```
4. è¯»å– imagesã€‚

&emsp;category ä¸­çš„åè®®ä¼šåŒæ—¶æ·»åŠ åˆ°ç±»å’Œå…ƒç±»ã€‚objc::unattachedCategories.addForClass(lc, cls) å¯ç†è§£ä¸ºæ“ä½œ key æ˜¯ clsã€value æ˜¯ category_list çš„å“ˆå¸Œè¡¨ï¼Œå½“å‰ cls è¿˜æ²¡æœ‰å®ç°ï¼Œé‚£è¿™äº› category çš„å†…å®¹ä»€ä¹ˆæ—¶å€™é™„åŠ åˆ°ç±»ä¸Šçš„ã€‚åœ¨ä¸Šä¸€èŠ‚æˆ‘ä»¬çœ‹ UnattachedCategories æ•°æ®ç»“æ„æ—¶ï¼Œçœ‹åˆ° attachToClass å‡½æ•°å°±æ˜¯åšè¿™ä¸ªäº‹æƒ…çš„ï¼ŒæŠŠäº‹å…ˆä¿å­˜çš„ category æ•°æ®é™„åŠ åˆ° cls ä¸Šã€‚å…¨å±€æœç´¢ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç° attachToClass åªä¼šåœ¨ methodizeClass é‡Œé¢è°ƒç”¨ï¼Œç„¶åå…¨å±€æœç´¢ methodizeClass å‡½æ•°ï¼Œå‘ç°åªæœ‰åœ¨ realizeClassWithoutSwift ä¸­è°ƒç”¨å®ƒã€‚

```c++
void attachLists(List* const * addedLists, uint32_t addedCount) {
    if (addedCount == 0) return;

    if (hasArray()) {
        // many lists -> many lists
        
        // è®°å½•ä¹‹å‰çš„é•¿åº¦
        uint32_t oldCount = array()->count;
        uint32_t newCount = oldCount + addedCount;
        
        // realloc åŸå‹: extern void *realloc(void *mem_address, unsigned int newsize);
        // æŒ‡é’ˆå =ï¼ˆæ•°æ®ç±»å‹*ï¼‰reallocï¼ˆè¦æ”¹å˜å†…å­˜å¤§å°çš„æŒ‡é’ˆåï¼Œæ–°çš„å¤§å°ï¼‰
        // è¿”å›å€¼: å¦‚æœé‡æ–°åˆ†é…æˆåŠŸåˆ™è¿”å›æŒ‡å‘è¢«åˆ†é…å†…å­˜çš„æŒ‡é’ˆï¼Œå¦åˆ™è¿”å›ç©ºæŒ‡é’ˆ NULL
        
        // å…ˆåˆ¤æ–­å½“å‰çš„æŒ‡é’ˆæ˜¯å¦æœ‰è¶³å¤Ÿçš„è¿ç»­ç©ºé—´ï¼Œå¦‚æœæœ‰ï¼Œæ‰©å¤§ mem_address æŒ‡å‘çš„åœ°å€ï¼Œ
        // å¹¶ä¸”å°† mem_address è¿”å›ï¼Œå¦‚æœç©ºé—´ä¸å¤Ÿï¼Œå…ˆæŒ‰ç…§ newsize æŒ‡å®šçš„å¤§å°åˆ†é…ç©ºé—´ï¼Œ
        // å°†åŸæœ‰æ•°æ®ä»å¤´åˆ°å°¾æ‹·è´åˆ°æ–°åˆ†é…çš„å†…å­˜åŒºåŸŸï¼Œ
        // è€Œåé‡Šæ”¾åŸæ¥ mem_address æ‰€æŒ‡å†…å­˜åŒºåŸŸï¼ˆæ³¨æ„ï¼šåŸæ¥æŒ‡é’ˆæ˜¯è‡ªåŠ¨é‡Šæ”¾ï¼Œä¸éœ€è¦ä½¿ç”¨ free ï¼‰ï¼Œ
        // åŒæ—¶è¿”å›æ–°åˆ†é…çš„å†…å­˜åŒºåŸŸçš„é¦–åœ°å€ï¼Œå³é‡æ–°åˆ†é…å­˜å‚¨å™¨å—çš„åœ°å€ã€‚
        
        // æ–°çš„å¤§å° å¯å¤§å¯å°ï¼ˆå¦‚æœæ–°çš„å¤§å°å¤§äºåŸå†…å­˜å¤§å°ï¼Œåˆ™æ–°åˆ†é…éƒ¨åˆ†ä¸ä¼šè¢«åˆå§‹åŒ–ï¼‰
        // å¦‚æœæ–°çš„å¤§å° å°äºåŸå†…å­˜å¤§å°ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±
        // æ³¨æ„äº‹é¡¹: 
        // é‡åˆ†é…æˆåŠŸæ—§å†…å­˜ä¼šè¢«è‡ªåŠ¨é‡Šæ”¾ï¼Œæ—§æŒ‡é’ˆå˜æˆäº†é‡æŒ‡é’ˆï¼Œå½“å†…å­˜ä¸å†ä½¿ç”¨æ—¶ï¼Œåº”ä½¿ç”¨free()å‡½æ•°å°†å†…å­˜å—é‡Šæ”¾ã€‚
        
        // æ‰©å±•ç©ºé—´
        setArray((array_t *)realloc(array(), array_t::byteSize(newCount)));
        // æ›´æ–° array é•¿åº¦ 
        array()->count = newCount;
        
        // åŸå‹ï¼švoid *memmove(void* dest, const void* src, size_t count);
        // ç”± src æ‰€æŒ‡å†…å­˜åŒºåŸŸå¤åˆ¶ count ä¸ªå­—èŠ‚åˆ° dest æ‰€æŒ‡å†…å­˜åŒºåŸŸã€‚
        // memmove ç”¨äºæ‹·è´å­—èŠ‚ï¼Œå¦‚æœç›®æ ‡åŒºåŸŸå’ŒæºåŒºåŸŸæœ‰é‡å çš„è¯ï¼Œ
        // memmove èƒ½å¤Ÿä¿è¯æºä¸²åœ¨è¢«è¦†ç›–ä¹‹å‰å°†é‡å åŒºåŸŸçš„å­—èŠ‚æ‹·è´åˆ°ç›®æ ‡åŒºåŸŸä¸­ï¼Œ
        // ä½†å¤åˆ¶åæºå†…å®¹ä¼šè¢«æ›´æ”¹ã€‚ä½†æ˜¯å½“ç›®æ ‡åŒºåŸŸä¸æºåŒºåŸŸæ²¡æœ‰é‡å åˆ™å’Œ memcpy å‡½æ•°åŠŸèƒ½ç›¸åŒã€‚
        
        // æŠŠæ–¹æ³•åˆ—è¡¨å‘åç§»åŠ¨ï¼Œç»™ addedLists ç•™å‡ºç©ºé—´ addedCount é•¿çš„ç©ºé—´
        memmove(array()->lists + addedCount, array()->lists, 
                oldCount * sizeof(array()->lists[0]));
        
        // åŸå‹ï¼švoid *memcpy(void *destin, void *source, unsigned n);
        // ä»æº source æ‰€æŒ‡çš„å†…å­˜åœ°å€çš„èµ·å§‹ä½ç½®å¼€å§‹æ‹·è´ n ä¸ªå­—èŠ‚åˆ°ç›®æ ‡ destin æ‰€æŒ‡çš„å†…å­˜åœ°å€çš„èµ·å§‹ä½ç½®ä¸­
        
        // æŠŠ addedLists å¤åˆ¶åˆ° array()->lists èµ·å§‹çš„å†…å­˜ç©ºé—´
        memcpy(array()->lists, addedLists, 
               addedCount * sizeof(array()->lists[0]));
    }
    else if (!list  &&  addedCount == 1) {
        // 0 lists -> 1 list
        // å¦‚æœç›®å‰ä¸ºç©ºï¼Œèµ‹å€¼æ“ä½œï¼ˆè¿™é‡Œæ˜¯èµ‹å€¼æ“ä½œï¼Œè¿™é‡Œæ˜¯èµ‹å€¼æ“ä½œï¼‰
        list = addedLists[0];
    } 
    else {
        // 1 list -> many lists
        List* oldList = list;
        uint32_t oldCount = oldList ? 1 : 0;
        uint32_t newCount = oldCount + addedCount;
        
        // æ‰©å®¹
        setArray((array_t *)malloc(array_t::byteSize(newCount)));
        // æ›´æ–° count 
        array()->count = newCount;
        // æŠŠ oldList æ”¾åœ¨ lists æœ«å°¾
        if (oldList) array()->lists[addedCount] = oldList;
        // æŠŠ addedLists å¤åˆ¶åˆ° array()->lists èµ·å§‹çš„å†…å­˜ç©ºé—´
        memcpy(array()->lists, addedLists, 
               addedCount * sizeof(array()->lists[0]));
    }
}
```

***

## 68. +load å‡½æ•°åˆ†æã€‚
+ å®ç° load çš„åˆ†ç±»å’Œç±»æ˜¯éæ‡’åŠ è½½åˆ†ç±»å’Œéæ‡’åŠ è½½ç±»ï¼Œæœªå®ç° +load å‡½æ•°çš„åˆ†ç±»å’Œç±»ï¼Œæ˜¯æ‡’åŠ è½½åˆ†ç±»å’Œæ‡’åŠ è½½ç±»ã€‚æ‡’åŠ è½½ç±»åªæœ‰æˆ‘ä»¬ç¬¬ä¸€æ¬¡ç”¨åˆ°å®ƒä»¬çš„æ—¶å€™ï¼Œæ‰ä¼šæ‰§è¡Œå®ç°ã€‚
+ load å‡½æ•°æ‰§è¡Œæ˜¯ç›´æ¥ç”±å…¶å‡½æ•°åœ°å€ç›´æ¥è°ƒç”¨çš„ï¼Œä¸èµ° objc_msgSend çš„å‡½æ•°æŸ¥æ‰¾æµç¨‹çš„ï¼Œæ‰€ä»¥ç±»å’Œåˆ†ç±»ä¸­çš„ load å‡½æ•°æ˜¯å®Œå…¨ä¸å­˜åœ¨ â€œè¦†ç›–â€ è¡Œä¸ºçš„ã€‚å®ƒä»¬éƒ½ä¼šæ‰§è¡Œï¼Œæ‰§è¡Œçš„æµç¨‹çš„è¯ï¼šé¦–å…ˆæ˜¯ ç±»ä¸€å®šæ—©äºåˆ†ç±»çš„ï¼Œç„¶åçˆ¶ç±»ä¸€å®šæ—©äºå­ç±»ï¼Œåˆ†ç±»ä¹‹é—´åˆ™æ˜¯è°å…ˆç¼–è¯‘åˆ™è°å…ˆæ‰§è¡Œã€‚ï¼ˆè¿™é‡Œåˆšå¥½å’Œä¸åŒåˆ†ç±»ä¸­çš„åŒåå‡½æ•°ï¼Œåç¼–è¯‘çš„åˆ†ç±»ä¸­çš„å‡½æ•°ä¼š â€œè¦†ç›–â€ å…ˆç¼–è¯‘çš„åˆ†ç±»ç›¸åã€‚ï¼‰
+ æ­£å¸¸æƒ…å†µæˆ‘ä»¬éƒ½ä¸åº”è¯¥æ‰‹åŠ¨è°ƒç”¨ load å‡½æ•°ï¼Œæˆ‘ä»¬åªè¦è¦äº¤ç»™ç³»ç»Ÿè‡ªå·±ç­‰å¾…è°ƒç”¨å³å¯ï¼Œä¸”å…¨å±€åªä¼šè°ƒç”¨ä¸€æ¬¡ã€‚

&emsp;void load_images(const char *path __unused, const struct mach_header *mh) å¤„ç†ç”± dyld æ˜ å°„çš„ç»™å®šçš„é•œåƒä¸­çš„ç±»å’Œåˆ†ç±»ä¸­çš„ +load å‡½æ•°ã€‚extern bool hasLoadMethods(const headerType *mhdr) åˆ¤æ–­ mach_header ä¸­æ˜¯å¦åŒ…å«éæ‡’åŠ è½½çš„ç±»å’Œåˆ†ç±»ï¼ˆå³å®ç°äº† load å‡½æ•°çš„ç±»å’Œåˆ†ç±»ï¼‰ã€‚extern void prepare_load_methods(const headerType *mhdr) è°ƒç”¨ load å‡½æ•°å‰çš„å‡†å¤‡ï¼Œå–å‡º mhdr ä¸­çš„ count ä¸ªéæ‡’åŠ è½½ç±»ï¼Œå¾ªç¯æŠŠä¸åŒç±»çš„ load å‡½æ•°æ·»åŠ è¿›å…¨å±€çš„ load æ–¹æ³•çš„æ•°ç»„ï¼ˆloadable_classesï¼‰ä¸­ï¼Œä¸”é¦–å…ˆé€’å½’æ·»åŠ çˆ¶ç±»çš„ +load å‡½æ•°ï¼Œç„¶åå–å‡ºåˆ†ç±»ä¸­çš„ load å‡½æ•°æ·»åŠ è¿›å…¨å±€çš„ load æ–¹æ³•çš„æ•°ç»„ï¼ˆloadable_classesï¼‰ä¸­ï¼Œä»è¿™é‡Œå·²ç»å¯ä»¥çœ‹å‡º load å‡½æ•°è°ƒç”¨ç±»æ—©äºåˆ†ç±»ï¼Œçˆ¶ç±»æ—©äºå­ç±»ã€‚

&emsp;å…·ä½“è¯¦ç»†çš„æ‰§è¡Œæµç¨‹ä¾‹å¦‚ load å‡½æ•°æ€ä¹ˆè¯»å–çš„ï¼Œæ€ä¹ˆæ‰§è¡Œçš„ç­‰ç­‰ç»†èŠ‚å¯å‚è€ƒï¼š[iOS Category åº•å±‚å®ç°åŸç†(ä¸‰)ï¼šé™„åŠ +loadå‡½æ•°è¶…è¯¦ç»†è§£æ](https://juejin.cn/post/6870436803220865031)

***

## 69. å‚¨å­˜å¼±å¼•ç”¨å˜é‡æ‰€ä½¿ç”¨åˆ°çš„æ•°æ®ç»“æ„ä¸€è§ˆã€‚
&emsp;template <typename T> class DisguisedPtr æ˜¯åœ¨ Project Headers/objc-private.h ä¸­å®šä¹‰çš„ä¸€ä¸ªæ¨¡ç‰ˆå·¥å…·ç±»ï¼Œä¸»è¦çš„åŠŸèƒ½æ˜¯æŠŠ T æŒ‡é’ˆï¼ˆT ç±»å‹å˜é‡çš„åœ°å€ï¼‰è½¬åŒ–ä¸ºä¸€ä¸ª unsigned longï¼Œå®ç°**æŒ‡é’ˆåˆ°æ•´æ•°çš„ç›¸äº’æ˜ å°„**ï¼Œèµ·åˆ°**æŒ‡é’ˆä¼ªè£…**çš„ä½œç”¨ï¼Œä½¿æŒ‡é’ˆéšè—äºç³»ç»Ÿå·¥å…·ï¼ˆå¦‚ leaks å·¥å…·ï¼‰ã€‚åœ¨ objc4-781 å…¨å±€æœç´¢ DisguisedPtr å‘ç°æŠ½è±¡ç±»å‹ T ä»…ä½œä¸º objc_object å’Œ objc_object * ä½¿ç”¨ã€‚è€ŒæŠ½è±¡ç±»å‹ T æ˜¯ objc_object * æ—¶ï¼Œç”¨äºéšè— \_\_weak å˜é‡çš„åœ°å€ã€‚DisguisedPtr<T> ç±»ä¼¼äºæŒ‡é’ˆç±»å‹ T *ï¼Œåªæ˜¯å­˜å‚¨çš„å€¼è¢«ä¼ªè£…æˆå¯¹è¯¸å¦‚ leaks ä¹‹ç±»çš„å·¥å…·éšè—ã€‚nil æœ¬èº«æ˜¯ä¼ªè£…çš„ï¼Œå› æ­¤ 0 å€¼çš„å†…å­˜å¯ä»¥æŒ‰é¢„æœŸå·¥ä½œï¼Œè®© nil æŒ‡é’ˆåƒ non-nil æŒ‡é’ˆé‚£æ ·æ­£å¸¸è¿è¡Œå®ƒçš„æ“ä½œï¼Œè€Œä¸ä¼šè®©ç¨‹åºå´©æºƒã€‚

&emsp;template<typename T> class StripedMap ä»æ•°æ®ç»“æ„è§’åº¦çœ‹çš„è¯ï¼Œå®ƒæ˜¯ä½œä¸ºä¸€ä¸ª Key æ˜¯ void *ï¼ŒValue æ˜¯ T çš„ hash è¡¨æ¥ç”¨çš„ã€‚åœ¨ objc4-781 ä¸­å…¨å±€æœç´¢ StripedMap å‘ç° T ä½œä¸º SideTable å’Œ spinlock_t ç±»å‹ä½¿ç”¨ã€‚

&emsp;SideTables ç±»å‹æ˜¯ï¼šStripedMap<SideTable>ã€‚SideTables çš„ä½¿ç”¨ï¼šSideTable *table = &SideTables()[obj] å®ƒçš„ä½œç”¨æ­£æ˜¯æ ¹æ® objc_object çš„æŒ‡é’ˆè®¡ç®—å‡ºå“ˆå¸Œå€¼ï¼Œç„¶åä» SideTables è¿™å¼ å…¨å±€å“ˆå¸Œè¡¨ä¸­æ‰¾åˆ° obj æ‰€å¯¹åº”çš„ SideTableã€‚

&emsp;typedef DisguisedPtr<objc_object *> weak_referrer_t; è¿™é‡Œ T æ˜¯ objc_object \*ï¼Œé‚£ä¹ˆ DisguisedPtr é‡Œçš„ T\* å°±æ˜¯ objc_object\*\*ï¼Œå³ä¸ºæŒ‡é’ˆçš„æŒ‡é’ˆã€‚ç”¨äºä¼ªè£… \_\_weak å˜é‡çš„åœ°å€ï¼Œå³ç”¨äºä¼ªè£… objc_object * çš„åœ°å€ã€‚

&emsp;out_of_line_ness å­—æ®µä¸ inline_referrers [1] çš„ä½ä¸¤ä½å†…å­˜ç©ºé—´é‡å ã€‚inline_referrers [1] æ˜¯æŒ‡é’ˆå¯¹é½åœ°å€çš„ DisguisedPtrã€‚æŒ‡é’ˆå¯¹é½çš„ DisguisedPtr çš„ä½ä¸¤ä½å§‹ç»ˆä¸º 0b00ï¼ˆ8 å­—èŠ‚å¯¹é½å–å¾—çš„åœ°å€çš„äºŒè¿›åˆ¶è¡¨ç¤ºçš„åä¸¤ä½å§‹ç»ˆæ˜¯ 0ï¼‰ï¼ˆä¼ªè£…ä¸º nil æˆ– 0x80..00ï¼‰æˆ– 0b11ï¼ˆä»»ä½•å…¶ä»–åœ°å€ï¼‰ã€‚å› æ­¤ï¼Œout_of_line_ness == 0b10 å¯ç”¨äºæ ‡è®° out-of-line çŠ¶æ€ï¼Œå³ struct weak_entry_t å†…éƒ¨æ˜¯ä½¿ç”¨å“ˆå¸Œè¡¨å­˜å‚¨ weak_referrer_t è€Œä¸å†ä½¿ç”¨é‚£ä¸ªé•¿åº¦ä¸º 4 çš„ weak_referrer_t æ•°ç»„ã€‚

&emsp;weak_entry_t çš„åŠŸèƒ½æ˜¯ä¿å­˜æ‰€æœ‰æŒ‡å‘æŸä¸ªå¯¹è±¡çš„å¼±å¼•ç”¨å˜é‡çš„åœ°å€ã€‚weak_entry_t çš„å“ˆå¸Œæ•°ç»„å†…å­˜å‚¨çš„æ•°æ®æ˜¯ typedef DisguisedPtr<objc_object *> weak_referrer_tï¼Œå®è´¨ä¸Šæ˜¯å¼±å¼•ç”¨å˜é‡çš„åœ°å€ï¼Œå³ objc_object **new_referrerï¼Œé€šè¿‡æ“ä½œæŒ‡é’ˆçš„æŒ‡é’ˆï¼Œå°±å¯ä»¥ä½¿å¾—å¼±å¼•ç”¨å˜é‡åœ¨å¯¹è±¡ææ„åæŒ‡å‘ nilã€‚è¿™é‡Œå¿…é¡»ä¿å­˜å¼±å¼•ç”¨å˜é‡çš„åœ°å€ï¼Œæ‰èƒ½æŠŠå®ƒçš„æŒ‡å‘ç½®ä¸º nilã€‚

&emsp;åœ¨ weak_entry_t ä¸­å½“å¯¹è±¡çš„å¼±å¼•ç”¨æ•°é‡ä¸è¶…è¿‡ 4 çš„æ—¶å€™æ˜¯ä½¿ç”¨ weak_referrer_t inline_referrers[WEAK_INLINE_COUNT] è¿™ä¸ªå›ºå®šé•¿åº¦ä¸º 4 çš„æ•°ç»„å­˜æ”¾ weak_referrer_tã€‚å½“é•¿åº¦å¤§äº 4 ä»¥åä½¿ç”¨ weak_referrer_t *referrers è¿™ä¸ªå“ˆå¸Œæ•°ç»„å­˜æ”¾ weak_referrer_t æ•°æ®ã€‚

&emsp;weak_table_t çš„å“ˆå¸Œæ•°ç»„åˆå§‹é•¿åº¦æ˜¯ 64ï¼Œå½“å­˜å‚¨å æ¯”è¶…è¿‡ 3/4 åï¼Œå“ˆå¸Œæ•°ç»„ä¼šæ‰©å®¹ä¸ºæ€»å®¹é‡çš„ 2 å€ï¼Œç„¶åä¼šæŠŠä¹‹å‰çš„æ•°æ®é‡æ–°å“ˆå¸ŒåŒ–æ”¾åœ¨æ–°ç©ºé—´å†…ã€‚å½“ä¸€äº›æ•°æ®ä»å“ˆå¸Œæ•°ç»„ä¸­ç§»é™¤åï¼Œä¸ºäº†æé«˜æŸ¥æ‰¾æ•ˆç‡åŠ¿å¿…è¦å¯¹å“ˆå¸Œæ•°ç»„æ€»é•¿åº¦åšç¼©å°æ“ä½œï¼Œè§„åˆ™æ˜¯å½“å“ˆå¸Œæ•°ç»„æ€»å®¹é‡è¶…è¿‡ 1024 ä¸”å·²ä½¿ç”¨éƒ¨åˆ†å°‘äºæ€»å®¹é‡ 1/16 æ—¶ï¼Œç¼©å°ä¸ºæ€»å®¹é‡çš„ 1/8ï¼Œç¼©å°ååŒæ ·ä¼šæŠŠåŸå§‹æ•°æ®é‡æ–°å“ˆå¸ŒåŒ–æ”¾åœ¨æ–°ç©ºé—´ã€‚ï¼ˆç¼©å°å’Œæ‰©å±•éƒ½æ˜¯ä½¿ç”¨ calloc å‡½æ•°å¼€è¾Ÿæ–°ç©ºé—´ï¼Œ`cache_t` æ‰©å®¹åæ˜¯ç›´æ¥å¿½ç•¥æ—§æ•°æ®ï¼Œè¿™é‡Œå¯ä»¥æ¯”è¾ƒè®°å¿†ã€‚ï¼‰ã€‚ç‰¢è®°ä»¥ä¸Šåªæ˜¯é’ˆå¯¹ weak_table_t çš„å“ˆå¸Œæ•°ç»„è€Œè¨€çš„ã€‚

&emsp;weak_entry_t åˆ™æ˜¯é¦–å…ˆç”¨å›ºå®šé•¿åº¦ä¸º 4 çš„æ•°ç»„ï¼Œå½“æœ‰æ–°çš„å¼±å¼•ç”¨è¿›æ¥æ—¶ï¼Œä¼šé¦–å…ˆåˆ¤æ–­å½“å‰æ˜¯ä½¿ç”¨çš„å®šé•¿æ•°ç»„è¿˜æ˜¯å“ˆå¸Œæ•°ç»„ï¼Œå¦‚æœæ­¤æ—¶ä½¿ç”¨çš„è¿˜æ˜¯å®šé•¿æ•°ç»„çš„è¯å…ˆåˆ¤æ–­å®šé•¿æ•°ç»„è¿˜æœ‰æ²¡æœ‰ç©ºä½ï¼Œå¦‚æœæ²¡æœ‰ç©ºä½çš„è¯ä¼šä¸ºå“ˆå¸Œæ•°ç»„ç”³è¯·é•¿åº¦ä¸º 4 çš„å¹¶ç”¨ä¸€ä¸ªå¾ªç¯æŠŠå®šé•¿æ•°ç»„ä¸­çš„æ•°æ®æ”¾åœ¨å“ˆå¸Œæ•°ç»„ï¼Œè¿™é‡Œçœ‹ä¼¼æ˜¯æŒ‰ä¸‹æ ‡å¾ªç¯å­˜æ”¾ï¼Œå…¶å®ä¸‹é¢ä¼šé‡æ–°è¿›è¡Œå“ˆå¸ŒåŒ–ï¼Œç„¶åæ˜¯åˆ¤æ–­å¯¹å“ˆå¸Œæ•°ç»„è¿›è¡Œæ‰©å®¹ï¼Œä¹Ÿæ˜¯å¦‚æœè¶…è¿‡æ€»å æ¯”çš„ 3/4 è¿›è¡Œæ‰©å®¹ä¸ºæ€»å®¹é‡çš„ 2 å€ï¼Œæ‰€ä»¥ weak_entry_t çš„å“ˆå¸Œæ•°ç»„ç¬¬ä¸€æ¬¡æ‰©å®¹åæ˜¯ 8ã€‚ç„¶åä¸‹é¢åŒºåˆ«å°±æ¥äº† weak_entry_t çš„å“ˆå¸Œæ•°ç»„æ˜¯æ²¡æœ‰ç¼©å°æœºåˆ¶çš„ï¼Œç§»é™¤å¼±å¼•ç”¨çš„æ“ä½œå…¶å®åªæ˜¯æŠŠå¼±å¼•ç”¨çš„æŒ‡å‘ç½®ä¸º nilï¼Œåšç§»é™¤æ“ä½œæ˜¯åˆ¤æ–­å¦‚æœå®šé•¿æ•°ç»„ä¸ºç©ºæˆ–è€…å“ˆå¸Œæ•°ç»„ä¸ºç©ºï¼Œåˆ™ä¼šæŠŠ weak_table_t å“ˆå¸Œæ•°ç»„ä¸­çš„ weak_entry_t ç§»é™¤ï¼Œç„¶åå°±æ˜¯å¯¹ weak_table_t åšä¸€äº›ç¼©å°å®¹é‡çš„æ“ä½œã€‚

&emsp;è¿™é‡Œ weak_entry_t ä¹‹æ‰€ä»¥ä¸ç¼©å°ï¼Œä¸”èµ·å§‹ç”¨å®šé•¿æ•°ç»„ï¼Œéƒ½æ˜¯å¯¹å…¶çš„ä¼˜åŒ–ï¼Œå› ä¸ºæœ¬æ¥ä¸€ä¸ªå¯¹è±¡çš„å¼±å¼•ç”¨æ•°é‡å°±ä¸ä¼šå¤ªå¤šã€‚

```c++
struct weak_entry_t {
    // referent ä¸­å­˜æ”¾çš„æ˜¯åŒ–èº«ä¸ºæ•´æ•°çš„ objc_object å®ä¾‹çš„åœ°å€ï¼Œä¸‹é¢ä¿å­˜çš„ä¸€ä¼—å¼±å¼•ç”¨å˜é‡éƒ½æŒ‡å‘è¿™ä¸ª objc_object å®ä¾‹
    DisguisedPtr<objc_object> referent;
    
    // å½“æŒ‡å‘ referent çš„å¼±å¼•ç”¨ä¸ªæ•°å°äºç­‰äº 4 æ—¶ä½¿ç”¨ inline_referrers æ•°ç»„ä¿å­˜è¿™äº›å¼±å¼•ç”¨å˜é‡çš„åœ°å€ï¼Œ
    // å¤§äº 4 ä»¥åç”¨ referrers è¿™ä¸ªå“ˆå¸Œæ•°ç»„ä¿å­˜ã€‚
    
    // å…±ç”¨ 32 ä¸ªå­—èŠ‚å†…å­˜ç©ºé—´çš„è”åˆä½“
    union {
        struct {
            weak_referrer_t *referrers; // ä¿å­˜ weak_referrer_t çš„å“ˆå¸Œæ•°ç»„
            
            // out_of_line_ness å’Œ num_refs æ„æˆä½åŸŸå­˜å‚¨ï¼Œå…±å  64 ä½
            uintptr_t        out_of_line_ness : 2; // æ ‡è®°ä½¿ç”¨å“ˆå¸Œæ•°ç»„è¿˜æ˜¯ inline_referrers ä¿å­˜ weak_referrer_t
            uintptr_t        num_refs : PTR_MINUS_2; // å½“å‰ referrers å†…ä¿å­˜çš„ weak_referrer_t çš„æ•°é‡
            uintptr_t        mask; // referrers å“ˆå¸Œæ•°ç»„æ€»é•¿åº¦å‡ 1ï¼Œä¼šå‚ä¸å“ˆå¸Œå‡½æ•°è®¡ç®—
            
            // å¯èƒ½ä¼šå‘ç”Ÿ hash å†²çªçš„æœ€å¤§æ¬¡æ•°ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦å‡ºç°äº†é€»è¾‘é”™è¯¯ï¼Œï¼ˆhash è¡¨ä¸­çš„å†²çªæ¬¡æ•°ç»å¯¹ä¸ä¼šè¶…è¿‡è¯¥å€¼ï¼‰
            // è¯¥å€¼åœ¨æ–°å»º weak_entry_t å’Œæ’å…¥æ–°çš„ weak_referrer_t æ—¶ä¼šè¢«æ›´æ–°ï¼Œå®ƒä¸€ç›´è®°å½•çš„éƒ½æ˜¯æœ€å¤§åç§»å€¼
            uintptr_t        max_hash_displacement;
        };
        struct {
            // out_of_line_ness å’Œ inline_referrers[1] çš„ä½ä¸¤ä½çš„å†…å­˜ç©ºé—´é‡åˆ
            // é•¿åº¦ä¸º 4 çš„ weak_referrer_tï¼ˆDsiguised<objc_object *>ï¼‰æ•°ç»„
            weak_referrer_t  inline_referrers[WEAK_INLINE_COUNT];
        };
    };
    
    // è¿”å› true è¡¨ç¤ºä½¿ç”¨ referrers å“ˆå¸Œæ•°ç»„ false è¡¨ç¤ºä½¿ç”¨ inline_referrers æ•°ç»„ä¿å­˜ weak_referrer_t
    bool out_of_line() {
        return (out_of_line_ness == REFERRERS_OUT_OF_LINE);
    }
    
    // weak_entry_t çš„èµ‹å€¼æ“ä½œï¼Œç›´æ¥ä½¿ç”¨ memcpy å‡½æ•°æ‹·è´ other å†…å­˜é‡Œé¢çš„å†…å®¹åˆ° this ä¸­ï¼Œ
    // è€Œä¸æ˜¯ç”¨å¤åˆ¶æ„é€ å‡½æ•°ä»€ä¹ˆçš„å½¢å¼å®ç°ï¼Œåº”è¯¥ä¹Ÿæ˜¯ä¸ºäº†æé«˜æ•ˆç‡è€ƒè™‘çš„...
    weak_entry_t& operator=(const weak_entry_t& other) {
        memcpy(this, &other, sizeof(other));
        return *this;
    }

    // weak_entry_t çš„æ„é€ å‡½æ•°
    
    // newReferent æ˜¯åŸå§‹å¯¹è±¡çš„æŒ‡é’ˆï¼Œ
    // newReferrer åˆ™æ˜¯æŒ‡å‘ newReferent çš„å¼±å¼•ç”¨å˜é‡çš„æŒ‡é’ˆã€‚
    
    // åˆå§‹åŒ–åˆ—è¡¨ referent(newReferent) ä¼šè°ƒç”¨: DisguisedPtr(T* ptr) : value(disguise(ptr)) { } æ„é€ å‡½æ•°ï¼Œ
    // è°ƒç”¨ disguise å‡½æ•°æŠŠ newReferent è½¬åŒ–ä¸ºä¸€ä¸ªæ•´æ•°èµ‹å€¼ç»™ valueã€‚
    weak_entry_t(objc_object *newReferent, objc_object **newReferrer)
        : referent(newReferent)
    {
        // æŠŠ newReferrer æ”¾åœ¨æ•°ç»„ 0 ä½ï¼Œä¹Ÿä¼šè°ƒç”¨ DisguisedPtr æ„é€ å‡½æ•°ï¼ŒæŠŠ newReferrer è½¬åŒ–ä¸ºæ•´æ•°ä¿å­˜
        inline_referrers[0] = newReferrer;
        // å¾ªç¯æŠŠ inline_referrers æ•°ç»„çš„å‰©ä½™ 3 ä½éƒ½ç½®ä¸º nil
        for (int i = 1; i < WEAK_INLINE_COUNT; i++) {
            inline_referrers[i] = nil;
        }
    }
};
```
&emsp;weak_entry_t å†…éƒ¨ä¹‹æ‰€ä»¥ä½¿ç”¨ **å®šé•¿æ•°ç»„/å“ˆå¸Œæ•°ç»„** çš„åˆ‡æ¢ï¼Œåº”è¯¥æ˜¯è€ƒè™‘åˆ°å®ä¾‹å¯¹è±¡çš„å¼±å¼•ç”¨å˜é‡ä¸ªæ•°ä¸€èˆ¬æ¯”è¾ƒå°‘ï¼Œè¿™æ—¶å€™ä½¿ç”¨å®šé•¿æ•°ç»„ä¸éœ€è¦å†åŠ¨æ€çš„ç”³è¯·å†…å­˜ç©ºé—´ï¼ˆunion ä¸­ä¸¤ä¸ªç»“æ„ä½“å…±ç”¨ 32  ä¸ªå­—èŠ‚å†…å­˜ï¼‰è€Œæ˜¯ä½¿ç”¨ weak_entry_t åˆå§‹åŒ–æ—¶ä¸€æ¬¡åˆ†é…çš„ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œè¿™ä¼šå¾—åˆ°è¿è¡Œæ•ˆç‡ä¸Šçš„æå‡ã€‚

&emsp;weak_table_t æ˜¯å…¨å±€çš„ä¿å­˜å¼±å¼•ç”¨çš„å“ˆå¸Œè¡¨ã€‚ä»¥ object ids ä¸º keysï¼Œä»¥ weak_entry_t ä¸º valuesã€‚

&emsp;struct SideTable å®šä¹‰ä½äº NSObject.mm æ–‡ä»¶ä¸­ã€‚å®ƒç®¡ç†äº†ä¸¤å—å¯¹æˆ‘ä»¬è€Œè¨€è¶…çº§é‡è¦çš„å†…å®¹ï¼Œä¸€å—æ˜¯ RefcountMap refcnts å­˜å‚¨å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œä¸€å—æ˜¯ weak_table_t weak_table å­˜å‚¨å¯¹è±¡çš„å¼±å¼•ç”¨å˜é‡ã€‚

&emsp;struct SideTable ç»“æ„å¾ˆæ¸…æ™°ï¼Œ3 ä¸ªæˆå‘˜å˜é‡:
1. spinlock_t slock; è‡ªæ—‹é”ï¼Œä¿è¯æ“ä½œ SideTable æ—¶çš„çº¿ç¨‹å®‰å…¨ã€‚çœ‹å‰é¢çš„ä¸¤å¤§å— weak_table_t å’Œ weak_entry_t çš„æ—¶å€™ï¼Œçœ‹åˆ°å®ƒä»¬æ‰€æœ‰çš„æ“ä½œå‡½æ•°éƒ½æ²¡æœ‰æåŠåŠ è§£é”çš„äº‹æƒ…ï¼Œå¦‚æœä½ ä»”ç»†è§‚å¯Ÿçš„è¯ä¼šå‘ç°å®ƒä»¬çš„å‡½æ•°ååé¢éƒ½æœ‰ä¸€ä¸ª no_lock çš„å°å°¾å·´ï¼Œæ­£æ˜¯ç”¨æ¥æé†’æˆ‘ä»¬ï¼Œå®ƒä»¬çš„æ“ä½œä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å…¶å®å®ƒä»¬æ˜¯æŠŠä¿è¯å®ƒä»¬çº¿ç¨‹å®‰å…¨çš„ä»»åŠ¡äº¤ç»™äº† SideTableï¼Œå¯ä»¥çœ‹åˆ° SideTable æä¾›çš„å‡½æ•°éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè€Œè¿™éƒ½æ˜¯ç”± slock æ¥å®Œæˆçš„ã€‚
2. RefcountMap refcnts: ä»¥ DisguisedPtr<objc_object> ä¸º keyï¼Œä»¥ size_t ä¸º value çš„å“ˆå¸Œè¡¨ï¼Œç”¨æ¥å­˜å‚¨å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼ˆä»…åœ¨æœªä½¿ç”¨ isa ä¼˜åŒ–æˆ–è€… isa ä¼˜åŒ–æƒ…å†µä¸‹ isa_t ä¸­ä¿å­˜çš„å¼•ç”¨è®¡æ•°æº¢å‡ºæ—¶æ‰ä¼šç”¨åˆ°ï¼Œè¿™é‡Œæ¶‰åŠåˆ° isa_t é‡Œçš„ uintptr_t has_sidetable_rc å’Œ uintptr_t extra_rc ä¸¤ä¸ªå­—æ®µã€‚ä½œä¸ºå“ˆå¸Œè¡¨ï¼Œå®ƒä½¿ç”¨çš„æ˜¯å¹³æ–¹æ¢æµ‹æ³•ä»å“ˆå¸Œè¡¨ä¸­å–å€¼ï¼Œè€Œ weak_table_t åˆ™æ˜¯çº¿æ€§æ¢æµ‹ï¼ˆå¼€æ”¾å¯»å€æ³•ï¼‰ã€‚
3. weak_table_t weak_table åˆ™æ˜¯å­˜å‚¨å¯¹è±¡å¼±å¼•ç”¨çš„å“ˆå¸Œè¡¨ï¼Œæ˜¯ weak åŠŸèƒ½å®ç°çš„æ ¸å¿ƒæ•°æ®ç»“æ„ã€‚

&emsp;spinlock_t åŸæœ¬æ˜¯ä¸€ä¸ª uint32_t ç±»å‹çš„**éå…¬å¹³çš„è‡ªæ—‹é”**ï¼Œï¼ˆç”±äºå…¶å®‰å…¨é—®é¢˜ï¼Œç›®å‰åº•å±‚å®ç°å·²ç”±äº’æ–¥é” os_unfair_lock æ‰€æ›¿ä»£ï¼‰ã€‚æ‰€è°“éå…¬å¹³æ˜¯æŒ‡ï¼Œè·å¾—é”çš„é¡ºåºå’Œç”³è¯·é”çš„é¡ºåºæ— å…³ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç¬¬ä¸€ä¸ªç”³è¯·é”çš„çº¿ç¨‹æœ‰å¯èƒ½ä¼šæ˜¯æœ€åä¸€ä¸ªè·å¾—è¯¥é”ï¼Œæˆ–è€…æ˜¯åˆšè·å¾—é”çš„çº¿ç¨‹ä¼šå†æ¬¡ç«‹åˆ»è·å¾—è¯¥é”ï¼Œé€ æˆå…¶å®ƒçº¿ç¨‹å¿™ç­‰ï¼ˆbusy-waitï¼‰ã€‚

&emsp;os_unfair_lock åœ¨å…¶æˆå‘˜å˜é‡ \_os_unfair_lock_opaque ä¸­è®°å½•äº†å½“å‰è·å–å®ƒçš„çº¿ç¨‹ä¿¡æ¯ï¼Œåªæœ‰è·å¾—è¯¥é”çš„çº¿ç¨‹æ‰èƒ½å¤Ÿè§£å¼€è¿™æŠŠé”ã€‚

&emsp;SideTables æ˜¯ä¸€ä¸ªç±»å‹æ˜¯ StripedMap<SideTable> çš„é™æ€å…¨å±€å“ˆå¸Œè¡¨ã€‚é€šè¿‡ä¸Šé¢ StripedMap çš„å­¦ä¹ ï¼Œå·²çŸ¥åœ¨ iPhone ä¸‹å®ƒæ˜¯å›ºå®šé•¿åº¦ä¸º 8 çš„å“ˆå¸Œæ•°ç»„ï¼Œåœ¨ mac ä¸‹æ˜¯å›ºå®šé•¿åº¦ä¸º 64 çš„å“ˆå¸Œæ•°ç»„ï¼Œè‡ªå¸¦ä¸€ä¸ªç®€å•çš„å“ˆå¸Œå‡½æ•°ï¼Œæ ¹æ® void * å…¥å‚è®¡ç®—å“ˆå¸Œå€¼ï¼Œç„¶åæ ¹æ®å“ˆå¸Œå€¼å–å¾—å“ˆå¸Œæ•°ç»„ä¸­å¯¹åº”çš„ Tã€‚SideTables ä¸­åˆ™æ˜¯å–å¾—çš„ T æ˜¯ SideTableã€‚

&emsp;SideTables() ä¸‹é¢å®šä¹‰äº†å¤šä¸ªä¸é”ç›¸å…³çš„å…¨å±€å‡½æ•°ï¼Œå†…éƒ¨å®ç°æ˜¯è°ƒç”¨ StripedMap çš„æ¨¡ç‰ˆæŠ½è±¡ç±»å‹ T æ‰€æ”¯æŒçš„å‡½æ•°æ¥å£ï¼Œå¯¹åº” SideTables çš„ T ç±»å‹æ˜¯ SideTableï¼Œè€Œ SideTable æ‰§è¡Œå¯¹åº”çš„å‡½æ•°æ—¶æ­£æ˜¯è°ƒç”¨äº†å®ƒçš„ spinlock_t slock æˆå‘˜å˜é‡çš„å‡½æ•°ã€‚è¿™é‡Œé‡‡ç”¨äº†åˆ†ç¦»é”çš„æœºåˆ¶ï¼Œå³ä¸€å¼  SideTable ä¸€æŠŠé”ï¼Œå‡è½»å¹¶è¡Œå¤„ç†å¤šä¸ªå¯¹è±¡æ—¶çš„é˜»å¡å‹åŠ›ã€‚

***

## 70. å¼±å¼•ç”¨å˜é‡ä½¿ç”¨åˆ°çš„å‡½æ•°ä¸€è§ˆã€‚
&emsp;`static weak_entry_t * weak_entry_for_referent(weak_table_t *weak_table, objc_object *referent);` æ ¹æ®ç»™å®šçš„ referentï¼ˆæˆ‘ä»¬çš„å¯¹è±¡å˜é‡ï¼‰å’Œ weak_table_t å“ˆå¸Œè¡¨ï¼ŒæŸ¥æ‰¾å¯¹åº”çš„ weak_entry_tï¼ˆå­˜æ”¾æ‰€æœ‰æŒ‡å‘ referent çš„å¼±å¼•ç”¨å˜é‡çš„åœ°å€çš„å“ˆå¸Œè¡¨ï¼‰ å¹¶è¿”å›ï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å› NULLã€‚

&emsp;`id weak_register_no_lock(weak_table_t *weak_table, id referent, id *referrer, bool crashIfDeallocating);` æ·»åŠ ä¸€å¯¹ï¼ˆobject, weak pointerï¼‰åˆ°å¼±å¼•ç”¨è¡¨é‡Œã€‚ï¼ˆå³å½“ä¸€ä¸ªå¯¹è±¡å­˜åœ¨ç¬¬ä¸€ä¸ªæŒ‡å‘å®ƒçš„ weak å˜é‡æ—¶ï¼Œæ­¤æ—¶ä¼šæŠŠå¯¹è±¡æ–°æ³¨å†Œè¿› weak_table_t çš„å“ˆå¸Œè¡¨ä¸­ï¼ŒåŒæ—¶ä¹Ÿä¼šæŠŠè¿™ç¬¬ä¸€ä¸ª weak å˜é‡çš„åœ°å€ä¿å­˜è¿›å¯¹è±¡çš„ weak_entry_t å“ˆå¸Œè¡¨ä¸­ï¼Œå¦‚æœè¿™ä¸ª weak å˜é‡ä¸æ˜¯ç¬¬ä¸€ä¸ªçš„è¯ï¼Œè¡¨æ˜è¿™ä¸ªå¯¹è±¡æ­¤æ—¶å·²ç»å­˜åœ¨äº weak_table_t å“ˆå¸Œè¡¨ä¸­äº†ï¼Œæ­¤æ—¶åªéœ€è¦æŠŠè¿™ä¸ªæŒ‡å‘å®ƒçš„ weak å˜é‡çš„åœ°å€ä¿å­˜è¿›è¯¥å¯¹è±¡çš„ weak_entry_t å“ˆå¸Œè¡¨ä¸­ã€‚ï¼‰

&emsp;`void weak_unregister_no_lock(weak_table_t *weak_table, id referent, id *referrer);` ä»å¼±å¼•ç”¨è¡¨é‡Œç§»é™¤ä¸€å¯¹ï¼ˆobject, weak pointerï¼‰ã€‚ï¼ˆä»å¯¹è±¡çš„ weak_entry_t å“ˆå¸Œè¡¨ä¸­ç§»é™¤ä¸€ä¸ª weak å˜é‡çš„åœ°å€ã€‚ï¼‰

&emsp;`void weak_clear_no_lock(weak_table_t *weak_table, id referent);` å½“å¯¹è±¡é”€æ¯çš„æ—¶å€™è¯¥å‡½æ•°è¢«è°ƒç”¨ã€‚è®¾ç½®æ‰€æœ‰å‰©ä½™çš„ \_\_weak å˜é‡æŒ‡å‘ nilï¼Œæ­¤å¤„æ­£å¯¹åº”äº†æˆ‘ä»¬æ—¥å¸¸æŒ‚åœ¨å˜´ä¸Šçš„ï¼š\_\_weak å˜é‡åœ¨å®ƒæŒ‡å‘çš„å¯¹è±¡è¢«é”€æ¯åå®ƒä¾¿ä¼šè¢«ç½®ä¸º nil çš„æœºåˆ¶ã€‚

&emsp;è°ƒæ•´ weak_table_t å“ˆå¸Œæ•°ç»„é•¿åº¦ï¼Œä»¥ weak_table_t æŒ‡é’ˆä¸ºå‚æ•°ï¼Œè°ƒç”¨ weak_grow_maybe å’Œ weak_compact_maybe è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œç”¨æ¥å½“ weak_table_t å“ˆå¸Œæ•°ç»„è¿‡æ»¡æˆ–è€…è¿‡ç©ºçš„æƒ…å†µä¸‹åŠæ—¶è°ƒæ•´å…¶é•¿åº¦ï¼Œä¼˜åŒ–å†…å­˜çš„ä½¿ç”¨æ•ˆç‡ï¼Œå¹¶æé«˜å“ˆå¸ŒæŸ¥æ‰¾æ•ˆç‡ã€‚è¿™ä¸¤ä¸ªå‡½æ•°éƒ½é€šè¿‡è°ƒç”¨ weak_resize å‡½æ•°æ¥è°ƒæ•´ weak_table_t å“ˆå¸Œæ•°ç»„çš„é•¿åº¦ã€‚

&emsp;`static void weak_grow_maybe(weak_table_t *weak_table);`  è¯¥å‡½æ•°ç”¨äºæ‰©å…… weak_table_t çš„ weak_entry_t *weak_entries çš„é•¿åº¦ï¼Œæ‰©å……æ¡ä»¶æ˜¯ num_entries è¶…è¿‡äº† mask + 1 çš„ 3/4ã€‚çœ‹åˆ° weak_entries çš„åˆå§‹åŒ–é•¿åº¦æ˜¯ 64ï¼Œæ¯æ¬¡æ‰©å……çš„é•¿åº¦åˆ™æ˜¯ mask + 1 çš„ 2 å€ï¼Œæ‰©å®¹å®Œæ¯•åä¼šæŠŠåŸå“ˆå¸Œæ•°ç»„ä¸­çš„ weak_entry_t é‡æ–°å“ˆå¸ŒåŒ–æ’å…¥åˆ°æ–°ç©ºé—´å†…ï¼Œå¹¶æ›´æ–° weak_tabl_t å„æˆå‘˜å˜é‡ã€‚å æ®çš„å†…å­˜ç©ºé—´çš„æ€»å®¹é‡åˆ™æ˜¯ (mask + 1) * sizeof(weak_entry_t) å­—èŠ‚ã€‚ç»¼ä¸Š mask + 1 æ€»æ˜¯ 2 çš„ N æ¬¡æ–¹ã€‚ï¼ˆåˆå§‹æ—¶ N æ˜¯ 6ï¼š2^6 = 64ï¼Œä»¥ååˆ™æ˜¯ N >= 6ï¼‰

&emsp;`static void weak_compact_maybe(weak_table_t *weak_table);` è¯¥å‡½æ•°ä¼šåœ¨ weak_entry_remove å‡½æ•°ä¸­è°ƒç”¨ï¼Œæ—¨åœ¨ weak_entry_t ä» weak_table_t çš„å“ˆå¸Œæ•°ç»„ä¸­ç§»é™¤åï¼Œå¦‚æœå“ˆå¸Œæ•°ç»„ä¸­å ç”¨æ¯”è¾ƒä½çš„è¯ï¼Œç¼©å° weak_entry_t *weak_entries çš„é•¿åº¦ï¼Œä¼˜åŒ–å†…å­˜ä½¿ç”¨ï¼Œæé«˜å“ˆå¸ŒæŸ¥æ‰¾æ•ˆç‡ã€‚ç¼©å° weak_entry_t *weak_entries é•¿åº¦çš„æ¡ä»¶æ˜¯å½“ç›®å‰çš„æ€»é•¿åº¦ **è¶…è¿‡äº† 1024** å¹¶ä¸”å®¹é‡ **å ç”¨æ¯”å°äº 1/16**ï¼Œweak_entries ç©ºé—´ç¼©å°åˆ°å½“å‰ç©ºé—´çš„ **1/8**ã€‚

&emsp;`static void weak_resize(weak_table_t *weak_table, size_t new_size);` æ‰©å¤§å’Œç¼©å°ç©ºé—´éƒ½ä¼šè°ƒç”¨è¿™ä¸ª weak_resize å…¬å…±å‡½æ•°ã€‚å…¥å‚æ˜¯ weak_table_t æŒ‡é’ˆå’Œä¸€ä¸ªæŒ‡å®šçš„é•¿åº¦å€¼ã€‚ weak_entry_insert å‡½æ•°å¯çŸ¥  weak_resize å‡½æ•°çš„æ•´ä½“ä½œç”¨ï¼Œè¯¥å‡½æ•°å¯¹å“ˆå¸Œæ•°ç»„é•¿åº¦è¿›è¡Œçš„æ‰©å¤§æˆ–ç¼©å°ï¼Œé¦–å…ˆæ ¹æ® new_size ç”³è¯·ç›¸åº”å¤§å°çš„å†…å­˜ï¼Œnew_entries æŒ‡é’ˆæŒ‡å‘è¿™å—æ–°ç”³è¯·çš„å†…å­˜ã€‚è®¾ç½® weak_table çš„ mask ä¸º new_size - 1ã€‚mask çš„ä½œç”¨æ˜¯è®°å½• weak_table æ€»å®¹é‡çš„å†…å­˜è¾¹ç•Œï¼Œæ­¤å¤– mask è¿˜ç”¨åœ¨å“ˆå¸Œå‡½æ•°ä¸­ä¿è¯ index ä¸ä¼šå“ˆå¸Œæ•°ç»„è¶Šç•Œã€‚weak_table_t çš„å“ˆå¸Œæ•°ç»„å¯èƒ½ä¼šå‘ç”Ÿå“ˆå¸Œç¢°æ’ï¼Œè€Œ weak_table_t ä½¿ç”¨äº† **å¼€æ”¾å¯»å€æ³•** æ¥å¤„ç†ç¢°æ’ã€‚å¦‚æœå‘ç”Ÿç¢°æ’çš„è¯ï¼Œå°†å¯»æ‰¾ç›¸é‚»ï¼ˆå¦‚æœå·²ç»åˆ°æœ€å°¾ç«¯çš„è¯ï¼Œåˆ™ä»å¤´å¼€å§‹ï¼‰çš„ä¸‹ä¸€ä¸ªç©ºä½ã€‚max_hash_displacement è®°å½•å½“å‰ weak_table å‘ç”Ÿè¿‡çš„æœ€å¤§çš„åç§»å€¼ã€‚æ­¤å€¼ä¼šåœ¨å…¶ä»–åœ°æ–¹ç”¨åˆ°ï¼Œä¾‹å¦‚ï¼šweak_entry_for_referent å‡½æ•°ï¼Œå¯»æ‰¾ç»™å®šçš„ referent åœ¨å¼±å¼•ç”¨è¡¨ä¸­çš„ entry æ—¶ï¼Œå¦‚æœåœ¨å“ˆå¸ŒæŸ¥æ‰¾è¿‡ç¨‹ä¸­ hash_displacement çš„å€¼è¶…è¿‡äº† weak_table->max_hash_displacement åˆ™è¡¨ç¤ºï¼Œä¸å­˜åœ¨è¦æ‰¾çš„ weak_entry_tã€‚

&emsp;ä¸Šé¢ä¸»è¦æµè§ˆäº† weak ç›¸å…³çš„çš„æ•°æ®ç»“æ„ï¼Œä»¥åŠä»å…¨å±€çš„ SideTable->weak_table ä¸­æŸ¥æ‰¾ä¿å­˜å¯¹è±¡çš„æ‰€æœ‰å¼±å¼•ç”¨çš„åœ°å€çš„ weak_entry_tï¼Œä»¥åŠ weak_table_t->weak_entries å“ˆå¸Œæ•°ç»„çš„é•¿åº¦è°ƒæ•´æœºåˆ¶ã€‚

&emsp;`static void append_referrer(weak_entry_t *entry, objc_object **new_referrer);` æ·»åŠ ç»™å®šçš„ referrer åˆ° weak_entry_t çš„å“ˆå¸Œæ•°ç»„ï¼ˆæˆ–å®šé•¿ä¸º 4 çš„å†…éƒ¨æ•°ç»„ï¼‰ã€‚

&emsp;`static void remove_referrer(weak_entry_t *entry, objc_object **old_referrer);` ä» weak_entry_t çš„å“ˆå¸Œæ•°ç»„ï¼ˆæˆ–å®šé•¿ä¸º 4 çš„å†…éƒ¨æ•°ç»„ï¼‰ä¸­åˆ é™¤å¼±å¼•ç”¨çš„åœ°å€ã€‚

&emsp;`static void weak_entry_insert(weak_table_t *weak_table, weak_entry_t *new_entry);` æ·»åŠ ä¸€ä¸ªæ–°çš„ weak_entry_t åˆ°ç»™å®šçš„ weak_table_t çš„å“ˆå¸Œæ•°ç»„ä¸­ã€‚

&emsp;`static void weak_entry_remove(weak_table_t *weak_table, weak_entry_t *entry);` ä» weak_table_t çš„å“ˆå¸Œæ•°ç»„ä¸­åˆ é™¤æŒ‡å®šçš„ weak_entry_tã€‚

&emsp;`static weak_entry_t * weak_entry_for_referent(weak_table_t *weak_table, objc_object *referent);` ä» weak_table_t çš„å“ˆå¸Œæ•°ç»„ä¸­æ‰¾åˆ° referent çš„ weak_entry_tï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å› NULLã€‚

&emsp;`void weak_clear_no_lock(weak_table_t *weak_table, id referent_id);` å½“å¯¹è±¡çš„ dealloc å‡½æ•°æ‰§è¡Œæ—¶ä¼šè°ƒç”¨æ­¤å‡½æ•°ï¼Œä¸»è¦åŠŸèƒ½æ˜¯å½“å¯¹è±¡è¢«é‡Šæ”¾åºŸå¼ƒæ—¶ï¼ŒæŠŠè¯¥å¯¹è±¡çš„å¼±å¼•ç”¨æŒ‡é’ˆå…¨éƒ¨æŒ‡å‘ nilï¼Œå½“å¯¹è±¡æ‰§è¡Œ dealloc æ—¶ä¼šè°ƒç”¨è¯¥å‡½æ•°ï¼Œé¦–å…ˆæ ¹æ®å…¥å‚ referent_id æ‰¾åˆ°å…¶åœ¨ weak_table ä¸­å¯¹åº”çš„ weak_entry_tï¼Œç„¶åéå† weak_entry_t çš„å“ˆå¸Œæ•°ç»„æˆ–è€… inline_referrers å®šé•¿æ•°ç»„é€šè¿‡é‡Œé¢å­˜å‚¨çš„ weak å˜é‡çš„åœ°å€ï¼ŒæŠŠ weak å˜é‡æŒ‡å‘ç½®ä¸º nilï¼Œæœ€åæŠŠ weak_entry_t ä» weak_table ä¸­ç§»é™¤ã€‚

***

## 71. weak å˜é‡ä»åˆå§‹åŒ–åˆ°è¢«ç½®ä¸º nil çš„æ•´ä¸ªè¿‡ç¨‹ã€‚
&emsp;ä¸ weak å˜é‡ç›¸å…³å‡½æ•°æ˜¯: objc_initWeakã€objc_storeWeakã€objc_destroyWeakï¼Œå®ƒä»¬åˆ†åˆ«è¡¨ç¤ºåˆå§‹åŒ– weak å˜é‡ã€weak å˜é‡èµ‹å€¼ï¼ˆä¿®æ”¹æŒ‡å‘ï¼‰ã€é”€æ¯ weak å˜é‡ã€‚

```c++
#import <Foundation/Foundation.h>
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        // insert code here...
        id obj = [NSObject new];
        id obj2 = [NSObject new];
        printf("Start tag\n");
        {
            __weak id weakPtr = obj; // è°ƒç”¨ objc_initWeak è¿›è¡Œ weak å˜é‡åˆå§‹åŒ–
            weakPtr = obj2; // è°ƒç”¨ objc_storeWeak ä¿®æ”¹ weak å˜é‡æŒ‡å‘
        } 
        // å‡ºäº†è¿™ä¸ªå³è¾¹èŠ±æ‹¬å·è°ƒç”¨ objc_destroyWeak å‡½æ•°è¿›è¡Œ weak å˜é‡é”€æ¯
        //ï¼ˆæ³¨æ„è¿™é‡Œæ˜¯ weak å˜é‡çš„é”€æ¯ï¼Œå¹¶ä¸æ˜¯ weak å˜é‡æŒ‡å‘çš„å¯¹è±¡é”€æ¯ï¼‰
        
        printf("End tag\n"); // â¬…ï¸ æ–­ç‚¹æ‰“åœ¨è¿™é‡Œ
    }
    return 0;
}
```

&emsp;`id objc_initWeak(id *location, id newObj);` å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°:
1. `id *location` å³ weak å˜é‡çš„åœ°å€ï¼Œå³ç¤ºä¾‹ä»£ç ä¸­ `weak` å˜é‡å–åœ°å€: `&weakPtr`ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡é’ˆçš„æŒ‡é’ˆï¼Œä¹‹æ‰€ä»¥è¦å­˜å‚¨æŒ‡é’ˆçš„åœ°å€ï¼Œæ˜¯å› ä¸º `weak` å˜é‡æŒ‡å‘çš„å¯¹è±¡é‡Šæ”¾åï¼Œè¦æŠŠ `weak` å˜é‡æŒ‡å‘ç½®ä¸º nilï¼Œå¦‚æœä»…å­˜å‚¨æŒ‡é’ˆï¼ˆå³ `weak` å˜é‡æ‰€æŒ‡å‘çš„åœ°å€å€¼ï¼‰çš„è¯ï¼Œæ˜¯ä¸èƒ½å¤Ÿå®Œæˆè¿™ä¸ªè®¾ç½®çš„ã€‚

  > è¿™é‡Œè”æƒ³åˆ°äº†å¯¹é“¾è¡¨åšä¸€äº›æ“ä½œæ—¶ï¼Œå‡½æ•°å…¥å‚ä¼šæ˜¯é“¾è¡¨å¤´æŒ‡é’ˆçš„æŒ‡é’ˆã€‚
    è¿™é‡Œå¦‚æœå¯¹æŒ‡é’ˆä¸æ˜¯ç‰¹åˆ«ç†Ÿæ‚‰çš„è¯ï¼Œå¯èƒ½ä¼šæœ‰ä¸€äº›è¿·ç³Šï¼Œä¸ºä»€ä¹ˆç”¨æŒ‡é’ˆçš„æŒ‡é’ˆï¼Œæˆ‘ä»¬ç›´æ¥åœ¨å‡½æ•°å†…ä¿®æ”¹å‚æ•°çš„æŒ‡å‘æ—¶ï¼Œä¸æ˜¯åŒæ ·ä¹Ÿä¿®æ”¹äº†å¤–éƒ¨æŒ‡é’ˆçš„æŒ‡å‘å—ï¼Ÿå…¶å®éç„¶ï¼
    ä¸€å®šè¦ç†æ¸…ï¼Œå½“å‡½æ•°å½¢å‚æ˜¯æŒ‡é’ˆæ—¶ï¼Œå®å‚ä¼ å…¥çš„æ˜¯ä¸€ä¸ªåœ°å€ï¼Œç„¶ååœ¨å‡½æ•°å†…éƒ¨åˆ›å»ºä¸€ä¸ªä¸´æ—¶æŒ‡é’ˆå˜é‡ï¼Œè¿™ä¸ªä¸´æ—¶æŒ‡é’ˆå˜é‡æŒ‡å‘çš„åœ°å€æ˜¯å®å‚ä¼ å…¥çš„åœ°å€ï¼Œæ­¤æ—¶å¦‚æœä½ ä¿®æ”¹æŒ‡å‘çš„è¯ï¼Œä¿®æ”¹çš„åªæ˜¯å‡½æ•°å†…éƒ¨çš„ä¸´æ—¶æŒ‡é’ˆå˜é‡çš„æŒ‡å‘ã€‚å¤–éƒ¨çš„æŒ‡é’ˆå˜é‡æ˜¯ä¸å®ƒæ— å…³çš„ï¼Œæœ‰å…³çš„åªæ˜¯åˆå§‹æ—¶å®ƒä»¬ä¸¤ä¸ªæŒ‡å‘çš„åœ°å€æ˜¯ä¸€æ ·çš„ã€‚è€Œæˆ‘ä»¬å¯¹è¿™ä¸ªåœ°å€é‡Œé¢å†…å®¹çš„æ‰€æœ‰æ“ä½œï¼Œéƒ½æ˜¯å¯ååº”åˆ°æŒ‡å‘è¯¥åœ°å€çš„æŒ‡é’ˆå˜é‡é‚£é‡Œçš„ã€‚è¿™ä¸ªåœ°å€æ˜¯æŒ‡é’ˆæŒ‡å‘çš„åœ°å€ï¼Œå¦‚æœæ²¡æœ‰ `const` é™åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹è¯¥åœ°å€é‡Œé¢çš„å†…å®¹åšä»»ä½•æ“ä½œå³ä½¿æŠŠå†…å®¹ç½®ç©ºæ”¾0ï¼Œè¿™äº›æ“ä½œéƒ½æ˜¯å¯¹è¿™ä¸ªåœ°å€çš„å†…å­˜åšçš„ï¼Œä¸ç®¡æ€æ ·è¿™å—å†…å­˜éƒ½æ˜¯å­˜åœ¨çš„ï¼Œå®ƒåœ°å€ä¸€ç›´éƒ½åœ¨è¿™é‡Œï¼Œè€Œæˆ‘ä»¬çš„åŸå§‹æŒ‡é’ˆä¸€ç›´å°±æ˜¯æŒ‡å‘å®ƒï¼Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦çš„æ˜¯ä¿®æ”¹åŸå§‹æŒ‡é’ˆçš„æŒ‡å‘ï¼Œé‚£æˆ‘ä»¬åªæœ‰çŸ¥é“æŒ‡é’ˆè‡ªèº«çš„åœ°å€æ‰è¡Œï¼Œæˆ‘ä»¬æŠŠæŒ‡é’ˆè‡ªèº«çš„åœ°å€çš„å†…å­˜ç©ºé—´é‡Œé¢æ”¾ `0x0`, æ‰èƒ½è¡¨ç¤ºæŠŠæˆ‘ä»¬çš„æŒ‡é’ˆæŒ‡å‘ç½®ä¸ºäº† `nil`ï¼

2. `id newObj`: æ‰€ç”¨çš„å¯¹è±¡ï¼Œå³ç¤ºä¾‹ä»£ç ä¸­çš„ `obj`ã€‚
è¯¥æ–¹æ³•æœ‰ä¸€ä¸ªè¿”å›å€¼ï¼Œè¿”å›çš„æ˜¯ `storeWeak` å‡½æ•°çš„è¿”å›å€¼ï¼š
è¿”å›çš„å…¶å®è¿˜æ˜¯ `obj`, ä½†æ˜¯å·²ç»å¯¹ `obj` çš„ `isaï¼ˆisa_tï¼‰` çš„ `weakly_referenced` ä½è®¾ç½®ä¸º `1`ï¼Œæ ‡è¯†è¯¥å¯¹è±¡æœ‰å¼±å¼•ç”¨å­˜åœ¨ï¼Œå½“è¯¥å¯¹è±¡é”€æ¯æ—¶ï¼Œè¦å¤„ç†æŒ‡å‘å®ƒçš„é‚£äº›å¼±å¼•ç”¨ï¼Œ`weak` å˜é‡è¢«ç½®ä¸º `nil` çš„æœºåˆ¶å°±æ˜¯ä»è¿™é‡Œå®ç°çš„ã€‚ 

&emsp;çœ‹ `objc_initWeak` å‡½æ•°å®ç°å¯çŸ¥ï¼Œå®ƒå†…éƒ¨æ˜¯è°ƒç”¨ `storeWeak` å‡½æ•°ï¼Œä¸”æ‰§è¡Œæ—¶çš„æ¨¡ç‰ˆå‚æ•°æ˜¯ `DontHaveOld`ï¼ˆæ²¡æœ‰æ—§å€¼ï¼‰ï¼Œè¿™é‡Œæ˜¯æŒ‡ `weakPtr` ä¹‹å‰æ²¡æœ‰æŒ‡å‘ä»»ä½•å¯¹è±¡ï¼Œæˆ‘ä»¬çš„ `weakPtr` æ˜¯åˆšåˆšåˆå§‹åŒ–çš„ï¼Œè‡ªç„¶æ²¡æœ‰æŒ‡å‘æ—§å€¼ã€‚è¿™é‡Œæ¶‰åŠåˆ°çš„æ˜¯ï¼Œå½“ `weak` å˜é‡æ”¹å˜æŒ‡å‘æ—¶ï¼Œè¦æŠŠè¯¥ `weak` å˜é‡åœ°å€ä»å®ƒä¹‹å‰æŒ‡å‘çš„å¯¹è±¡çš„ `weak_entry_t` çš„å“ˆå¸Œæ•°ç»„ä¸­ç§»é™¤ã€‚`DoHaveNew` è¡¨ç¤ºæœ‰æ–°å€¼ã€‚

&emsp;`storeWeak` å‡½æ•°å®ç°çš„æ ¸å¿ƒåŠŸèƒ½:
+ å°† `weak` å˜é‡çš„åœ°å€ `location` å­˜å…¥ `obj` å¯¹åº”çš„ `weak_entry_t` çš„å“ˆå¸Œæ•°ç»„ï¼ˆæˆ–å®šé•¿ä¸º `4` çš„æ•°ç»„ï¼‰ä¸­ï¼Œç”¨äºåœ¨ `obj` ææ„æ—¶ï¼Œé€šè¿‡è¯¥å“ˆå¸Œæ•°ç»„æ‰¾åˆ°å…¶æ‰€æœ‰çš„ `weak` å˜é‡çš„åœ°å€ï¼Œå°† `weak` å˜é‡æŒ‡å‘çš„åœ°å€ï¼ˆ`*location`ï¼‰ç½®ä¸º `nil`ã€‚
+ å¦‚æœå¯ç”¨äº† `isa` ä¼˜åŒ–ï¼Œåˆ™å°† `obj` çš„ `isa_t` çš„ `weakly_referenced` ä½ç½®ä¸º 1ï¼Œç½®ä¸º 1 çš„ä½œç”¨æ˜¯æ ‡è¯† `obj` å­˜åœ¨ `weak` å¼•ç”¨ã€‚å½“å¯¹è±¡ `dealloc` æ—¶ï¼Œ`runtime` ä¼šæ ¹æ® `weakly_referenced` æ ‡å¿—ä½æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦æŸ¥æ‰¾ `obj` å¯¹åº”çš„ `weak_entry_t`ï¼Œå¹¶å°†å®ƒçš„æ‰€æœ‰çš„å¼±å¼•ç”¨ç½®ä¸º `nil`ã€‚

&emsp;`__weak id weakPtr = obj` ä¸€å¥å®Œæ•´çš„ç™½è¯ç†è§£å°±æ˜¯ï¼šæ‹¿ç€ `weakPtr` çš„åœ°å€å’Œ `obj`ï¼Œè°ƒç”¨ `objc_initWeak` å‡½æ•°ï¼ŒæŠŠ `weakPtr` çš„åœ°å€æ·»åŠ åˆ° `objc` çš„å¼±å¼•ç”¨å“ˆå¸Œè¡¨ `weak_entry_t` çš„å“ˆå¸Œæ•°ç»„ä¸­ï¼Œå¹¶æŠŠ `obj` çš„åœ°å€èµ‹ç»™ `*location`ï¼ˆ`*location = (id)newObj`ï¼‰ï¼Œç„¶åæŠŠ `obj` çš„ `isa` çš„ `weakly_referenced` å­—æ®µç½®ä¸º `1`ï¼Œæœ€åè¿”å› `obj`ã€‚




## ğŸ‰ğŸ‰ğŸ‰ æœªå®Œå¾…ç»­...
